```markdown
# Electric Vehicle Routing Problem (EVRP) Solver

This repository contains a Python implementation of an Electric Vehicle Routing Problem (EVRP) solver. The EVRP extends the traditional Vehicle Routing Problem by incorporating electric vehicles with limited energy capacity, charging stations, and pickup/delivery demands. The solver uses a clustering-based approach with an optional 2-opt optimization to generate routes for multiple vehicles.

## Features
- **Input Parsing**: Reads problem instances from a custom `.evrp` file format.
- **Clustering**: Uses KMeans to assign customers to vehicles based on geographic proximity.
- **Energy Management**: Tracks energy consumption and schedules charging at stations when needed.
- **Routing**: Constructs feasible routes considering weight capacity, energy constraints, and pickup/delivery demands.
- **Optimization**: Optional 2-opt local search to improve route efficiency.
- **Visualization**: Generates plots of the network and vehicle routes with pickup/delivery details.

## Requirements
- Python 3.6+
- Libraries:
  - `numpy`
  - `scikit-learn`
  - `matplotlib`
  - `networkx`

Install dependencies using:
```bash
pip install numpy scikit-learn matplotlib networkx
```

## Files
- `evrp.py`: Core EVRP solver class, handling data loading, clustering, routing, and optimization.
- `visualize.py`: Functions to plot the network and vehicle routes.
- `main.py`: Entry point to run the solver and generate visualizations.
- `generate_evrp.py`: Utility to create random `.evrp` input files.
- `input.evrp`: Sample input file (generated by `generate_evrp.py`).

## Usage
1. **Generate an Input File** (optional):
   Run `generate_evrp.py` to create a random `input.evrp` file:
   ```bash
   python generate_evrp.py
   ```
   This generates a problem with 10 vehicles, 20 customers, 4 charging stations, and random coordinates/demands.

2. **Run the Solver**:
   Execute `main.py` to solve the EVRP and generate visualizations:
   ```bash
   python main.py
   ```
   - The solver reads `input.evrp`.
   - Outputs route details, distances, energy consumption, and charging events to the console.
   - Saves two plots: `network.png` (node network) and `all_routes.png` (vehicle routes).

3. **Customize**:
   - Modify `input.evrp` or create a new `.evrp` file following the format below.
   - Enable/disable 2-opt optimization by setting `use_two_opt=True/False` in `main.py`.

## Input File Format (`.evrp`)
The input file defines the problem instance:
```
# Parameters
NUM_VEHICLES: <int>
WEIGHT_CAPACITY: <float>
ENERGY_CAPACITY: <float>
ENERGY_MIN: <float>
ENERGY_RATE: <float>
CHARGE_RATE: <float>

# Nodes
DEPOT: <id> <x> <y>
CUSTOMERS: <count>
<customer_id> <x> <y>
...
CHARGING_STATIONS: <count>
<station_id> <x> <y>
...

# Demands
PICKUP:
<node_id> <pickup_amount>
...
DELIVERY:
<node_id> <delivery_amount>
...
```
- **Parameters**: Number of vehicles, vehicle capacities, energy constraints, and charging rate.
- **Nodes**: Depot (id=0), customers (ids=1 to N), and charging stations (ids=201+).
- **Demands**: Pickup and delivery amounts for each node (0 for depot/stations).

## Output
- **Console**:
  - Route for each vehicle (node sequence starting/ending at depot).
  - Total distance traveled (km).
  - Total energy consumed (units).
  - Charging events (station, amount, time, percentage).
  - Solve time (seconds).
- **Plots**:
  - `network.png`: Graph of nodes (depot: green, customers: blue, stations: red) with random edges.
  - `all_routes.png`: Directed graph of all vehicle routes with node labels showing pickup/delivery.

## Example
For the default `input.evrp`:
- 10 vehicles, 150 weight capacity, 100 energy capacity.
- 20 customers, 4 charging stations, 1 depot.
- Random coordinates in a 50x50 grid.
- Random pickup/delivery demands (5-30 units).

Run:
```bash
python main.py
```

Sample console output:
```
Processing Vehicle 1/10 (Cluster size: 2)
  Vehicle 1: Visiting node 5 from 0 (Energy: 100.00)
  ...
Vehicle 1 Route:
Path: 0 -> 5 -> 12 -> 0
Distance Traveled: 85.23 km
Energy Consumed: 42.15 units
Charging Events: 1
  Charge 1 at Station 201: 50.00 units, 1.00 mins, 50.00%
...
Solve time: 0.45 seconds
```

## Notes
- The solver uses a greedy nearest-neighbor approach within clusters, with energy checks to ensure feasibility.
- Charging occurs when energy falls below 50% capacity or is insufficient to return to the depot.
- The 2-opt optimization (disabled by default) may improve routes but increases runtime.
- Visualization assumes charging station IDs are 201-204; adjust `visualize.py` if using different IDs.
- Random seed is set for reproducibility in `generate_evrp.py` and KMeans clustering.

## Future Improvements
- Implement advanced heuristics (e.g., genetic algorithms, simulated annealing).
- Optimize charging station selection.
- Support time windows or dynamic demands.
- Parallelize clustering and optimization for larger instances.

## License
This project is licensed under the MIT License.
```

This README provides a clear overview, setup instructions, file descriptions, usage guide, input/output details, and suggestions for future work, tailored to the provided EVRP code.
